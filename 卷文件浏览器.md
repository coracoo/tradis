# 卷文件浏览器（临时容器方案）

Tradis Client 端支持在「存储卷」页面对 Docker Volume 进行可视化文件管理。实现方式为：后端按需创建一个**临时辅助容器**挂载目标卷，并通过后端反向代理把文件管理界面呈现到浏览器新窗口；窗口关闭后自动清理临时容器。

## 使用方式

1. 进入「存储卷」页面。
2. 在目标卷行点击「浏览文件」按钮。
3. 系统会打开一个新窗口展示文件管理界面（支持浏览、上传、下载、编辑等）。
4. 关闭窗口后，系统会自动停止并删除临时容器。

## 行为说明

- 临时容器镜像：`filebrowser/filebrowser:v2.59.0`
- 临时容器命名：`tradis-volume-browser-<session>`
- 授权方式：仅允许管理员打开（服务端校验 `username=admin`）
- 卷挂载路径：挂载到容器 `/srv`
- 只读保护：若检测到卷正在被任意容器使用，将以只读方式挂载，避免冲突
- 访问方式：优先将容器内部 80 端口映射到本机 `127.0.0.1:<随机端口>`，由后端反向代理统一转发；若环境不支持端口映射则回退到容器 IP（兼容不同 Docker 网络实现）
- 清理策略：
  - 窗口关闭会发送 close 请求触发清理
  - 页面每 15 秒发送一次 heartbeat；超过 2 分钟无心跳会被后台清理
  - 防止服务重启遗留：首次启用会清理所有旧的临时浏览容器（按 label 匹配）
  - 清理时会同时删除临时容器的匿名卷，避免系统产生越来越多的无主 volume

## 接口（REST）

- `POST /api/volumes/:name/browse/start`
  - 返回：`{ sessionId, url, readOnly }`
  - `url` 为新窗口打开的地址（已包装心跳与关闭逻辑）
- `POST /api/volumes/browse/:sid/heartbeat`
- `POST /api/volumes/browse/:sid/close`
- `GET  /api/volumes/browse/:sid/ui`
- `ANY  /api/volumes/browse/:sid/fb/*path`（内部反向代理）

## 可观测性

启用/关闭浏览器会写入「消息中心」通知，便于排查用户操作与容器清理情况。

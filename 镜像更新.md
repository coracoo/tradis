# 镜像更新方案

## 现状复盘
- 更新检测：后端通过镜像 digest 对比，写入 image_updates 表，支持定时与手动检测
- Images 页面：可手动检测更新、展示可更新状态，支持一键更新“未使用镜像”
- 使用中镜像：当前一键更新会跳过使用中的镜像，并提示去编排或容器页升级

## 目标
- 保留 Images 页的更新提醒与批量更新能力
- 在 Compose 页面增加更新提醒与一键更新入口
- 对“使用中镜像”采用成熟的更新机制，不重复造轮子

## 方案概览
1. **检测与状态来源**：继续使用现有 digest 检测与 image_updates 表，不新增重复检测链路
2. **归属聚合**：将可更新镜像按“Compose 项目 / 单容器”归属聚合，生成 Compose 级提醒
3. **更新执行策略**：
   - Compose 项目：使用 docker compose pull + up -d 的成熟机制更新
   - 单容器：使用 Docker Engine 官方流程（拉取镜像→停止→重建容器→启动）

## 关键流程
### A. Compose 更新提醒与一键更新
- 规则：任何 Compose 项目内的服务镜像出现在 image_updates 时标记为“可更新”
- 一键更新动作：
  - docker compose pull
  - docker compose up -d --remove-orphans --force-recreate
- 输出：使用现有 runComposeStreamLines 机制输出日志，前端复用既有 SSE 展示

### B. 单容器更新
- 规则：非 Compose 容器但镜像处于可更新状态时提示“需要重建容器”
- 更新动作（成熟流程）：
  - docker pull 最新镜像
  - stop container
  - recreate container（复用 inspect 的 Config/HostConfig/NetworkSettings）
  - start container
- UI：在容器页给出“更新并重建”入口，避免 Images 页直接操作使用中镜像

## 接口设计（建议）
- GET /compose/updates
  - 返回每个项目的 updateCount、affectedTags、projectName
- POST /compose/:name/updates/apply
  - 执行 docker compose pull + up -d，SSE 输出日志
- GET /containers/updates
  - 返回单容器更新状态，用于容器页展示
- POST /containers/:id/updates/apply
  - 执行容器重建流程

## 前端交互
- Images 页
  - 继续展示更新状态与“检测更新”
  - “一键更新未使用镜像”保留
  - 使用中镜像提示跳转 Compose 或容器页
- Compose 页
  - 顶部增加“可更新”提示徽标与“一键更新”按钮
  - 项目行展示可更新数量与受影响服务

## 风险与约束
- 多 tag 同 ID 情况需按 RepoTag 进行精确匹配
- 私有仓库认证需复用现有 registry 认证逻辑
- 自身项目需继续禁止一键更新

## 验收标准
- Compose 页出现可更新提示与一键更新入口
- 触发更新后容器完成重建并运行在最新镜像
- Images 页的“使用中镜像”不再直接更新，转交成熟路径处理

FROM golang:1.22-alpine AS backend-builder
RUN apk add --no-cache build-base sqlite-dev
ENV CGO_ENABLED=1
WORKDIR /app/backend
COPY backend/go.mod backend/go.sum ./
RUN go mod download
COPY backend ./
RUN go build -ldflags="-s -w" -o /app/bin/backend ./cmd/main.go

FROM node:20-alpine AS frontend-builder
WORKDIR /app/client/frontend
ARG VITE_MANAGEMENT_MODE=CS
ENV VITE_MANAGEMENT_MODE=$VITE_MANAGEMENT_MODE
COPY frontend/package*.json ./
RUN npm ci
COPY frontend ./
RUN npm run build

FROM alpine:3.19
ENV BACKEND_PORT=8080
ENV PROJECT_ROOT=
RUN apk add --no-cache tini sqlite-libs docker-cli docker-cli-compose nginx netcat-openbsd
WORKDIR /app
COPY --from=backend-builder /app/bin/backend /app/backend/backend
COPY --from=frontend-builder /app/client/frontend/dist /usr/share/nginx/html
COPY --from=frontend-builder /app/client/frontend/dist /app/client/backend/dist
RUN mkdir -p /etc/nginx/http.d
COPY start_sim.sh /app/start.sh
RUN chmod +x /app/start.sh
VOLUME ["/app/client/backend/data"]
VOLUME ["/app/client/backend/project"]
VOLUME ["/var/run/docker.sock"]
VOLUME ["/etc/docker/daemon.json"]
HEALTHCHECK --interval=30s --timeout=5s --start-period=30s --retries=3 CMD sh -c 'nc -z 127.0.0.1 ${BACKEND_PORT:-8080}'
ENTRYPOINT ["/sbin/tini","-g","--"]
CMD ["/bin/sh","/app/start.sh"]

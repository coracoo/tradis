# 稳定性降载（高负载自适应）

当机器上部署了资源占用较高的应用（例如包含数据库/向量库/队列/爬虫等多组件的应用栈）时，Docker Engine 以及宿主机的 CPU/内存/磁盘 IO 会出现明显抖动。此时 tradis 侧如果仍保持高频刷新与“逐容器 Inspect”重负载请求，体验上会表现为页面卡顿、SSE/WS 偶发断连、操作超时等“不稳定”现象。

本仓库在 Client 端加入了“自适应降载”，让管理面板在高负载时更温和。

## 触发条件（后端判断）

后端根据宿主机资源快照判断负载等级：

- normal：CPU < 88% 且内存使用 < 85%
- high：CPU ≥ 88% 或内存使用 ≥ 85%
- critical：CPU ≥ 95% 或内存使用 ≥ 92%

负载等级每秒缓存一次，避免高频请求反复采样造成额外开销。

实现位置：
- [load_shedding.go](file:///home/cherry/tradis/client/backend/pkg/system/load_shedding.go)

## 后端行为（容器列表自动降载）

容器列表接口会按负载等级自动调整“Inspect 策略”，降低对 Docker Engine 的压力：

- normal：对列表中所有容器执行 Inspect（并发上限 8）
- high：仅对运行中容器执行 Inspect（并发上限 4）
- critical：跳过 Inspect（仅返回 Docker List 基础字段）

同时对镜像更新映射（image update map）增加短 TTL 缓存，并在高负载下拉长 TTL，减少 DB 重复扫描。

实现位置：
- [ListContainers](file:///home/cherry/tradis/client/backend/api/container.go#L145)
- [buildContainerListItem](file:///home/cherry/tradis/client/backend/api/container.go#L245)

## 响应头（用于观测与调参）

后端会在以下接口响应中附带两个头，便于排查与观察：

- X-Tradis-Load-Level: normal | high | critical
- X-Tradis-Suggested-Refresh-Seconds: 5 | 10 | 20

当前已覆盖：
- `GET /api/containers`
- `GET /api/system/info`

## 前端行为（统一切换标准）

前端使用统一的切换标准：由后端响应头提供负载等级与建议刷新间隔，前端在 HTTP 响应拦截器中采集并存入共享模块，所有轮询/延迟刷新都以同一套标准计算间隔。

实现位置：
- [loadShedding.js](file:///home/cherry/tradis/client/frontend/src/shared/loadShedding.js)
- [http/index.js](file:///home/cherry/tradis/client/frontend/src/shared/http/index.js)

## 前端行为（轮询自适应）

概览页的轮询刷新从固定 5s 改为自适应：

- CPU/内存 ≥ 90%：20s
- CPU/内存 ≥ 75%：10s
- 其他：5s

页面不可见时保持不刷新；卸载/切换页面时使用序号守卫避免残留定时器。

实现位置：
- [Overview.vue](file:///home/cherry/tradis/client/frontend/src/views/Overview.vue#L300-L345)

同时已将以下页面的定时刷新/操作后的延迟刷新改为使用统一标准：
- 端口页（轮询刷新）：[Ports.vue](file:///home/cherry/tradis/client/frontend/src/views/Ports.vue#L284-L296)
- 项目详情页（容器状态轮询）：[ProjectDetail.vue](file:///home/cherry/tradis/client/frontend/src/views/ProjectDetail.vue#L690-L760)
- 容器详情页（详情轮询与 stats 轮询回退）：[DockerDetail.vue](file:///home/cherry/tradis/client/frontend/src/views/DockerDetail.vue#L430-L535)
- Compose 页（启动/停止/部署结束后的延迟刷新）：[Compose.vue](file:///home/cherry/tradis/client/frontend/src/views/Compose.vue#L1396-L1420)
- Projects 页（部署完成后的延迟刷新）：[Projects.vue](file:///home/cherry/tradis/client/frontend/src/views/Projects.vue#L430-L465)

## 开发验证注意事项

如果通过 AppStore 部署的应用在 `client/backend/project/**` 下生成了权限较严格的目录（例如 root-only 的配置/数据目录），`go test ./...` 在递归扫描模块目录时可能遇到 permission denied。此时可改用以下范围进行测试：

```bash
go test ./api/... ./pkg/... ./cmd/...
```
